lens:
  metadata:
    name: "PR Reviewer"
    domain: "code-quality"
    version: "1.0.0"
    description: "Structured pull request review with focus on quality, security, and maintainability"
    author: "Sunwell Team"
    license: "MIT"
    use_cases:
      - "Pull request review"
      - "Code review"
      - "Merge readiness assessment"
      - "PR feedback"
    tags:
      - "code-review"
      - "pull-request"
      - "quality"
      - "collaboration"

  extends: code-reviewer

  # ==========================================================================
  # HEURISTICS â€” How to Think
  # ==========================================================================

  heuristics:
    principles:
      - name: "Atomic Changes"
        rule: "One PR, one purpose"
        test: "Can the PR title be a single sentence?"
        always:
          - "Single logical change per PR"
          - "Related changes grouped together"
          - "Refactoring separate from features"
        never:
          - "Mixing unrelated changes"
          - "Bundling 'while I was here' fixes"
          - "Features + refactoring in one PR"
        examples:
          good: |
            PR: "Add rate limiting to API endpoints"
            - Rate limiter middleware
            - Tests for rate limiting
            - Documentation update
          bad: |
            PR: "Add rate limiting and fix user validation and update deps"
        priority: 10

      - name: "Testable"
        rule: "PR includes tests for changes"
        test: "Are there tests covering the new/changed code?"
        always:
          - "New functionality has tests"
          - "Bug fixes have regression tests"
          - "Tests run in CI"
        never:
          - "Untested new features"
          - "Bug fixes without reproduction test"
          - "'Will add tests later'"
        priority: 9

      - name: "Reviewable Size"
        rule: "< 400 lines ideal, < 1000 max"
        test: "Can this be reviewed in one session?"
        always:
          - "Split large changes into stacked PRs"
          - "Keep cognitive load manageable"
          - "Make each PR independently reviewable"
        never:
          - "2000+ line PRs"
          - "10+ files changed for unrelated reasons"
        thresholds:
          ideal: 400
          acceptable: 1000
          needs_split: 2000
        priority: 9

      - name: "Clear Description"
        rule: "PR description explains why, not just what"
        test: "Does the description explain motivation?"
        always:
          - "Problem/motivation section"
          - "Solution summary"
          - "Testing done"
          - "Screenshots for UI changes"
        never:
          - "Empty description"
          - "Just 'fixes bug'"
          - "Copy of commit messages only"
        priority: 8

      - name: "Self-Reviewed"
        rule: "Author reviewed their own diff before requesting"
        always:
          - "Remove debug code"
          - "Check for typos"
          - "Verify tests pass locally"
          - "Update documentation"
        priority: 7

      - name: "Backward Compatible"
        rule: "Changes don't break existing users"
        always:
          - "Deprecation warnings before removal"
          - "Migration path documented"
          - "Feature flags for risky changes"
        never:
          - "Silent breaking changes"
          - "Removing without deprecation"
        priority: 8

    anti_heuristics:
      - name: "Kitchen Sink PR"
        description: "PR with unrelated changes"
        triggers:
          - "and also"
          - "while I was here"
          - "unrelated fix"
        correction: "Split into separate PRs"

      - name: "Tests Later"
        description: "Shipping without tests"
        triggers:
          - "will add tests"
          - "tests TODO"
          - "manual testing only"
        correction: "Add tests before merge"

      - name: "LGTM Without Looking"
        description: "Rubber stamp approvals"
        triggers:
          - "lgtm"
          - "approved in 30 seconds"
          - "no comments on large PR"
        correction: "Provide substantive feedback"

    communication:
      tone:
        - Constructive
        - Specific
        - Respectful
        - Educational
      structure: "Summary â†’ Blockers â†’ Suggestions â†’ Nitpicks"

  # ==========================================================================
  # FRAMEWORK â€” Methodology
  # ==========================================================================

  framework:
    name: "Review Checklist"
    description: "Structured PR review methodology"
    decision_tree: |
      Ask: "Is this PR ready to merge?"
      
      Check correctness â†’ CORRECTNESS
      Check security â†’ SECURITY
      Check performance â†’ PERFORMANCE
      Check readability â†’ READABILITY
      Check testing â†’ TESTING
      Check documentation â†’ DOCUMENTATION

    categories:
      - name: "CORRECTNESS"
        purpose: "Does it do what it claims?"
        checks:
          - "Logic errors"
          - "Edge cases handled"
          - "Error handling"
          - "Race conditions"

      - name: "SECURITY"
        purpose: "Is it secure?"
        checks:
          - "Input validation"
          - "Authentication/authorization"
          - "No secrets exposed"
          - "SQL injection"

      - name: "PERFORMANCE"
        purpose: "Is it performant?"
        checks:
          - "No O(nÂ²) algorithms"
          - "No N+1 queries"
          - "Appropriate caching"
          - "Memory usage"

      - name: "READABILITY"
        purpose: "Is it maintainable?"
        checks:
          - "Clear naming"
          - "Appropriate comments"
          - "Consistent style"
          - "Single responsibility"

      - name: "TESTING"
        purpose: "Is it tested?"
        checks:
          - "Unit tests"
          - "Integration tests"
          - "Edge case coverage"
          - "Tests actually test the change"

      - name: "DOCUMENTATION"
        purpose: "Is it documented?"
        checks:
          - "README updated"
          - "API docs updated"
          - "Comments for complex logic"
          - "Changelog entry"

  # ==========================================================================
  # PERSONAS â€” Adversarial Testing
  # ==========================================================================

  personas:
    - name: "future_maintainer"
      description: "Developer maintaining this code in 6 months"
      background: "Will need to understand and modify this code"
      goals:
        - "Understand what the code does"
        - "Know why decisions were made"
        - "Safely make changes"
      friction_points:
        - "Magic numbers"
        - "Unclear variable names"
        - "Missing context"
      attack_vectors:
        - "Why was this approach chosen?"
        - "What's this constant?"
        - "Is this safe to modify?"

    - name: "new_team_member"
      description: "Junior developer learning the codebase"
      background: "Following team practices"
      goals:
        - "Learn good patterns"
        - "Understand conventions"
        - "Submit similar PRs"
      attack_vectors:
        - "Is this our standard practice?"
        - "Should I follow this pattern?"
        - "What's the reasoning here?"

    - name: "on_call_engineer"
      description: "SRE debugging at 3am"
      background: "Needs to understand code during incident"
      goals:
        - "Quick understanding"
        - "Find failure modes"
        - "Identify rollback points"
      attack_vectors:
        - "What could fail here?"
        - "How do I debug this?"
        - "Can I safely rollback?"

  # ==========================================================================
  # VALIDATORS â€” Quality Gates
  # ==========================================================================

  validators:
    deterministic:
      - name: "has_tests"
        script: "find . -name '*test*.py' -newer HEAD~1"
        severity: "warning"
        description: "PR should include tests"

      - name: "reasonable_size"
        script: "git diff --stat HEAD~1 | tail -1 | grep -E '[0-9]+' -o | head -1"
        severity: "info"
        description: "Check PR size"

    heuristic:
      - name: "single_purpose"
        check: "PR addresses a single concern"
        method: "checklist"
        confidence_threshold: 0.8
        severity: "warning"

      - name: "description_quality"
        check: "PR has meaningful description with context"
        method: "checklist"
        confidence_threshold: 0.75
        severity: "warning"

      - name: "backward_compatible"
        check: "Changes don't break existing functionality"
        method: "code_analysis"
        confidence_threshold: 0.85
        severity: "error"

  # ==========================================================================
  # ROUTER â€” Intent and Skill Routing
  # ==========================================================================

  router:
    tiers:
      - level: 0
        name: "Quick Review"
        triggers:
          - "quick look"
          - "obvious issues only"
          - "typo fix"
        retrieval: false
        validation: false

      - level: 1
        name: "Standard Review"
        triggers: []
        retrieval: true
        validation: true

      - level: 2
        name: "Deep Review"
        triggers:
          - "security sensitive"
          - "critical path"
          - "core changes"
        retrieval: true
        validation: true
        personas:
          - "future_maintainer"
          - "on_call_engineer"
        require_confirmation: true

    shortcuts:
      "::pr": "PR review"
      "::quick": "Quick review (obvious issues only)"
      "::deep": "Deep review with all checks"
      "::split": "Suggest how to split large PR"

  # ==========================================================================
  # SKILLS â€” Action Capabilities
  # ==========================================================================

  skills:
    - name: "review-pr"
      description: "Comprehensive PR review"
      type: inline
      triggers:
        - "review"
        - "pr review"
        - "pull request"
      instructions: |
        ## Goal
        Provide structured, actionable PR review.
        
        ## Output Format
        ```markdown
        ## Summary
        [Overall assessment and recommendation]
        
        ## ðŸš« Blockers
        [Must fix before merge]
        
        ## ðŸ’¡ Suggestions
        [Should consider, but not blocking]
        
        ## ðŸ“ Nitpicks
        [Style/preference, optional]
        
        ## âœ… What's Good
        [Positive feedback]
        ```
        
        ## Guidelines
        - Be specific: line numbers, code examples
        - Be constructive: suggest alternatives
        - Be kind: assume good intent
        - Prioritize: blockers > suggestions > nitpicks
      validate_with:
        validators:
          - single_purpose
          - description_quality
        min_confidence: 0.8

    - name: "split-pr"
      description: "Suggest how to split a large PR"
      type: inline
      triggers:
        - "split pr"
        - "break up"
        - "too large"
      instructions: |
        ## Goal
        Suggest logical splits for a large PR.
        
        ## Process
        1. Identify distinct logical changes
        2. Find natural boundaries
        3. Order by dependency
        4. Create stacked PR plan
        
        ## Output
        ```markdown
        ## Suggested Split
        
        ### PR 1: [Title]
        Files: [list]
        Depends on: none
        
        ### PR 2: [Title]
        Files: [list]
        Depends on: PR 1
        ```

    - name: "pr-description"
      description: "Generate PR description template"
      type: inline
      triggers:
        - "pr description"
        - "description template"
      instructions: |
        ## Goal
        Create comprehensive PR description.
        
        ## Template
        ```markdown
        ## What
        [Brief description of changes]
        
        ## Why
        [Motivation and context]
        
        ## How
        [Implementation approach]
        
        ## Testing
        - [ ] Unit tests added
        - [ ] Integration tests added
        - [ ] Manual testing done
        
        ## Screenshots
        [If applicable]
        
        ## Checklist
        - [ ] Self-review done
        - [ ] Tests pass
        - [ ] Docs updated
        ```

  # ==========================================================================
  # SCANNER â€” State DAG Configuration
  # ==========================================================================

  scanner:
    type: pull_request
    description: "Scan PR context"

    detect_markers:
      - ".github/PULL_REQUEST_TEMPLATE.md"
      - ".github/CODEOWNERS"
      - "CONTRIBUTING.md"

    health_probes:
      - name: "pr_template_exists"
        description: "PR template is configured"
        severity: "info"

      - name: "codeowners_exists"
        description: "CODEOWNERS is configured"
        severity: "info"

  # ==========================================================================
  # QUALITY POLICY
  # ==========================================================================

  quality_policy:
    min_confidence: 0.75
    required_validators: []
    persona_agreement: 0.5
    retry_limit: 2
